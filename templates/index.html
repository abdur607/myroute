<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyRoute — Fuel-Efficient Navigation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;500;600&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue-1: #78A2CC;
      --blue-3: #96B9D0;
      --blue-6: #BFD4DB;
      --paper:  #F4F1EC;
      --ink:    #1C2B3A;
      --ink-2:  #3A5068;
      --ink-3:  #6B8299;
      --rule:   #D8DFE6;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--paper);
      color: var(--ink);
      font-family: 'Outfit', sans-serif;
      min-height: 100vh;
    }

    /* ── Full-page split ── */
    .shell {
      display: grid;
      grid-template-columns: 1fr 440px;
      min-height: 100vh;
    }

    /* ── Left side ── */
    .left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 80px 72px;
      position: relative;
      overflow: hidden;
    }
    .left-map-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: auto;
      background:
        radial-gradient(1200px 700px at 12% 12%, rgba(191, 212, 219, 0.55), rgba(191, 212, 219, 0) 62%),
        radial-gradient(900px 600px at 82% 74%, rgba(164, 195, 210, 0.42), rgba(164, 195, 210, 0) 66%),
        linear-gradient(150deg, rgba(191, 212, 219, 0.36) 0%, rgba(174, 203, 214, 0.26) 46%, rgba(150, 185, 208, 0.2) 100%);
    }
    .left-map-bg svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0.72;
    }
    .left-map-bg .cars {
      position: absolute;
      inset: 0;
    }
    .left-map-bg .car {
      position: absolute;
      width: 11px;
      height: 5px;
      border-radius: 3px;
      background: #5f88b3;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.32);
      transform-origin: center;
      opacity: 0.95;
      will-change: transform;
      z-index: 1;
    }
    .left-map-bg .car::before {
      content: "";
      position: absolute;
      left: 2px;
      top: 1px;
      width: 4px;
      height: 3px;
      border-radius: 1px;
      background: rgba(255, 255, 255, 0.65);
    }
    .left-map-bg .c1 {
      background: #6b94bc;
    }
    .left-map-bg .c2 {
      background: #7ea2c4;
    }
    .left-map-bg .c3 {
      background: #89aac9;
    }
    .left-map-bg .c4 {
      background: #7399c0;
    }
    .left-map-bg .c5 {
      background: #5b86b2;
    }
    .left-map-bg .c6 {
      background: #6c90b8;
    }

    .form-header {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 16px;
      margin-bottom: 30px;
    }
    .form-title-wrap { min-width: 0; }
    .hero-wordmark {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: clamp(76px, 7.2vw, 124px);
      font-weight: 700;
      line-height: 0.9;
      letter-spacing: -0.01em;
      color: var(--blue-1);
      margin-bottom: 34px;
      position: relative;
      z-index: 2;
      width: fit-content;
    }

    .headline {
      font-family: 'Playfair Display', serif;
      font-size: clamp(40px, 4.2vw, 64px);
      font-weight: 700;
      line-height: 1.06;
      letter-spacing: -0.5px;
      margin-bottom: 24px;
      position: relative;
      z-index: 2;
      max-width: 640px;
    }
    .headline em {
      font-style: italic;
      color: var(--blue-1);
    }

    .subline {
      font-size: 16px;
      line-height: 1.7;
      color: var(--ink-3);
      font-weight: 300;
      max-width: 420px;
      margin-bottom: 72px;
      position: relative;
      z-index: 2;
    }

    /* Three simple stats — no boxes, just inline */
    .stats {
      display: flex;
      gap: 48px;
      position: relative;
      z-index: 2;
    }
    .stat-num {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--blue-1);
      line-height: 1;
      margin-bottom: 4px;
    }
    .stat-label {
      font-family: 'Courier Prime', monospace;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--ink-3);
    }

    /* ── Right form side ── */
    .right {
      background: #fff;
      border-left: 1px solid var(--rule);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 64px 48px;
    }

    .form-title {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .form-sub {
      font-size: 14px;
      color: var(--ink-3);
      margin-bottom: 0;
      font-weight: 300;
    }

    /* ── Inputs ── */
    .field-label {
      font-family: 'Courier Prime', monospace;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--ink-3);
      margin-bottom: 8px;
      display: block;
    }

    .field-row { margin-bottom: 20px; position: relative; }

    .field-wrap {
      position: relative;
      margin-bottom: 8px;
    }
    .field-wrap:last-child { margin-bottom: 0; }

    .field-prefix {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 40px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Courier Prime', monospace;
      font-size: 12px;
      color: var(--ink-3);
      border-right: 1px solid var(--rule);
      pointer-events: none;
      z-index: 2;
    }

    input, select {
      width: 100%;
      padding: 12px 14px 12px 50px;
      background: var(--paper);
      border: 1px solid var(--rule);
      color: var(--ink);
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      outline: none;
      border-radius: 0;
      -webkit-appearance: none;
      transition: border-color 0.15s;
    }
    input:focus, select:focus {
      border-color: var(--blue-1);
      background: #fff;
    }
    input::placeholder { color: var(--ink-3); font-weight: 300; }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236B8299' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-color: var(--paper);
      padding-right: 36px;
      cursor: pointer;
    }
    select:focus { background-color: #fff; }
    option { background: #fff; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    /* Confirmed */
    .field-confirmed input { border-color: var(--blue-1); background: #f0f6fb; }
    .confirm-tick {
      display: none; position: absolute; right: 12px; top: 50%;
      transform: translateY(-50%);
      font-size: 13px; color: var(--blue-1); font-weight: 700; z-index: 3;
    }
    .field-confirmed .confirm-tick { display: block; }

    /* Autocomplete */
    .autocomplete-wrap { position: relative; }
    .ac-list {
      display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 9999;
      background: #fff; border: 1px solid var(--blue-3); border-top: none;
      list-style: none; max-height: 220px; overflow-y: auto;
      box-shadow: 0 8px 20px rgba(28,43,58,0.10);
    }
    .ac-list.open { display: block; }
    .ac-list li { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--rule); font-size: 13px; transition: background 0.1s; }
    .ac-list li:last-child { border-bottom: none; }
    .ac-list li:hover, .ac-list li.highlighted { background: #EEF4F9; }
    .ac-short { font-weight: 500; color: var(--ink); }
    .ac-full  { font-size: 11px; color: var(--ink-3); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Divider */
    .divider {
      height: 1px; background: var(--rule); margin: 24px 0;
    }

    /* Vehicle preview — just a quiet line, no box */
    .vehicle-preview { display: none; margin-top: 10px; }
    .vehicle-preview.show { display: flex; align-items: baseline; gap: 16px; }
    .vp-name { font-size: 13px; font-weight: 500; color: var(--ink-2); }
    .vp-specs { display: flex; gap: 12px; }
    .vp-spec { font-family: 'Courier Prime', monospace; font-size: 11px; color: var(--blue-1); }
    .vp-spec-label { color: var(--ink-3); }

    /* Driving style pills */
    .style-pills {
      display: flex;
      gap: 0;
      margin-bottom: 8px;
    }
    .style-pill {
      flex: 1;
      padding: 9px 0;
      text-align: center;
      border: 1px solid var(--rule);
      border-right: none;
      font-size: 13px;
      color: var(--ink-3);
      cursor: pointer;
      transition: background 0.12s, color 0.12s;
      user-select: none;
    }
    .style-pill:last-child { border-right: 1px solid var(--rule); }
    .style-pill input[type="radio"] { display: none; }
    .style-pill:has(input:checked),
    .style-pill.active {
      background: var(--ink);
      color: var(--paper);
      border-color: var(--ink);
    }
    .style-pill:has(input:checked) + .style-pill { border-left-color: var(--ink); }
    .style-note {
      font-family: 'Courier Prime', monospace;
      font-size: 10px;
      color: var(--ink-3);
      letter-spacing: 0.04em;
      margin-top: 2px;
    }

    /* Submit */
    .btn-submit {
      width: 100%; margin-top: 28px;
      padding: 14px 20px;
      background: var(--ink);
      color: var(--paper);
      border: none;
      font-family: 'Outfit', sans-serif;
      font-size: 15px; font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-submit:hover { background: var(--blue-1); }
    .btn-submit.loading { opacity: 0.65; pointer-events: none; }
    .spinner { display: none; width: 14px; height: 14px; border: 2px solid rgba(244,241,236,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; }
    .btn-submit.loading .btn-text { display: none; }
    .btn-submit.loading .spinner { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .footnote { font-family: 'Courier Prime', monospace; font-size: 10px; letter-spacing: 0.05em; color: var(--ink-3); text-align: center; margin-top: 14px; }

    /* Responsive */
    @media (max-width: 900px) {
      .shell { grid-template-columns: 1fr; }
      .left { padding: 56px 32px 40px; }
      .form-header { margin-bottom: 24px; }
      .hero-wordmark {
        font-size: clamp(62px, 11vw, 92px);
        margin-bottom: 22px;
      }
      .right { border-left: none; border-top: 1px solid var(--rule); padding: 40px 32px 56px; }
      .stats { gap: 32px; }
    }
    @media (max-width: 480px) {
      .left { padding: 40px 24px 32px; }
      .hero-wordmark {
        font-size: clamp(52px, 17vw, 74px);
        margin-bottom: 16px;
      }
      .right { padding: 32px 24px 48px; }
      .grid-2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="shell">

  <!-- Left -->
  <main class="left">
    <div class="left-map-bg" aria-hidden="true">
      <svg viewBox="0 0 1200 800" preserveAspectRatio="none">
        <g fill="none" stroke-linecap="round">
          <path id="route1" d="M -180 120 C 120 40, 380 60, 700 150 C 900 208, 1130 242, 1380 212" stroke="#27496A" stroke-width="42"/>
          <path id="route2" d="M -150 744 C 130 676, 348 590, 620 468 C 870 356, 1120 320, 1380 342" stroke="#8EB1D9" stroke-width="38"/>
          <path id="route3" d="M 1380 794 C 1180 742, 980 700, 820 640 C 660 582, 520 564, 360 622 C 170 692, 10 770, -200 868" stroke="#27496A" stroke-width="34"/>
          <path id="route4" d="M -180 564 C 100 526, 330 444, 610 320 C 860 210, 1110 126, 1380 60" stroke="#98B6D4" stroke-width="28"/>
          <path id="route5" d="M 40 -140 C 238 82, 400 246, 600 354 C 820 474, 1080 622, 1380 850" stroke="#7B9FCF" stroke-width="24"/>
          <path id="route6" d="M 1158 -180 C 1022 -40, 930 122, 860 262 C 812 358, 748 450, 646 538 C 492 674, 260 826, -220 980" stroke="#88AED0" stroke-width="20"/>
        </g>
      </svg>
      <div class="cars">
        <span class="car c1" data-route="route1" data-speed="82" data-phase="0.07"></span>
        <span class="car c2" data-route="route2" data-speed="78" data-phase="0.33"></span>
        <span class="car c3" data-route="route3" data-speed="80" data-phase="0.59"></span>
        <span class="car c4" data-route="route4" data-speed="84" data-phase="0.21"></span>
        <span class="car c5" data-route="route5" data-speed="76" data-phase="0.47"></span>
        <span class="car c6" data-route="route6" data-speed="79" data-phase="0.71"></span>
        <span class="car c2" data-route="route1" data-speed="75" data-phase="0.49"></span>
        <span class="car c4" data-route="route2" data-speed="83" data-phase="0.12"></span>
        <span class="car c6" data-route="route3" data-speed="77" data-phase="0.86"></span>
        <span class="car c1" data-route="route4" data-speed="81" data-phase="0.38"></span>
        <span class="car c3" data-route="route5" data-speed="74" data-phase="0.63"></span>
        <span class="car c5" data-route="route6" data-speed="80" data-phase="0.25"></span>
      </div>
    </div>
    <div class="hero-wordmark" aria-hidden="true">MyRoute</div>

    <h1 class="headline">
      Find the route<br>that burns <em>least.</em>
    </h1>

    <div class="stats">
      <div>
        <div class="stat-num">40+</div>
        <div class="stat-label">Vehicles</div>
      </div>
      <div>
        <div class="stat-num">15+</div>
        <div class="stat-label">Routes scored</div>
      </div>
      <div>
        <div class="stat-num">28</div>
        <div class="stat-label">Physical forces considered</div>
      </div>
    </div>
  </main>

  <!-- Right form -->
  <aside class="right">
    <div class="form-header">
      <div class="form-title-wrap">
        <h2 class="form-title">Plan your journey</h2>
        <p class="form-sub">Enter your route and vehicle below.</p>
      </div>
    </div>

    <form id="routeForm" action="/results" method="GET">
      <input type="hidden" name="start_lat" id="start_lat">
      <input type="hidden" name="start_lon" id="start_lon">
      <input type="hidden" name="end_lat"   id="end_lat">
      <input type="hidden" name="end_lon"   id="end_lon">

      <div class="field-row">
        <span class="field-label">Route</span>
        <div class="autocomplete-wrap field-wrap" id="field-start">
          <div class="field-prefix">A</div>
          <input type="text" name="start" id="start" placeholder="Starting location" required autocomplete="off">
          <span class="confirm-tick">✓</span>
          <ul class="ac-list" id="ac-start"></ul>
        </div>
        <div class="autocomplete-wrap field-wrap" id="field-end">
          <div class="field-prefix">B</div>
          <input type="text" name="end" id="end" placeholder="Destination" required autocomplete="off">
          <span class="confirm-tick">✓</span>
          <ul class="ac-list" id="ac-end"></ul>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field-row" style="margin-bottom: 0;">
        <span class="field-label">Vehicle</span>
        <div class="grid-2">
          <div class="field-wrap">
            <div class="field-prefix">▸</div>
            <select name="make" id="makeSelect" required>
              <option value="" disabled selected>Make</option>
              {% for make in makes %}
              <option value="{{ make }}">{{ make }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field-wrap">
            <div class="field-prefix">▸</div>
            <select name="model" id="modelSelect" required>
              <option value="" disabled selected>Model</option>
            </select>
          </div>
        </div>
        <div class="vehicle-preview" id="vehiclePreview">
          <span class="vp-name" id="vpName"></span>
          <div class="vp-specs">
            <span class="vp-spec"><span class="vp-spec-label">Cd </span><span id="vpDrag"></span></span>
            <span class="vp-spec"><span class="vp-spec-label">eff </span><span id="vpEff"></span></span>
            <span class="vp-spec"><span class="vp-spec-label"></span><span id="vpWeight"></span><span class="vp-spec-label"> kg</span></span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field-row" style="margin-bottom: 0;">
        <span class="field-label">Driving style</span>
        <div class="style-pills">
          <label class="style-pill">
            <input type="radio" name="style" value="calm"> Calm
          </label>
          <label class="style-pill active">
            <input type="radio" name="style" value="normal" checked> Normal
          </label>
          <label class="style-pill">
            <input type="radio" name="style" value="aggressive"> Aggressive
          </label>
        </div>
        <p class="style-note">Affects acceleration frequency and speed profile</p>
      </div>

      <button type="submit" class="btn-submit" id="submitBtn">
        <span class="btn-text">Calculate route →</span>
        <div class="spinner"></div>
      </button>
    </form>

    <p class="footnote">OpenRouteService · Nominatim</p>
  </aside>
</div>

<script>
function makeAutocomplete(cfg) {
  const input = document.getElementById(cfg.inputId);
  const list  = document.getElementById(cfg.listId);
  const latEl = document.getElementById(cfg.latId);
  const lonEl = document.getElementById(cfg.lonId);
  const field = document.getElementById(cfg.fieldId);
  let timer = null, suggestions = [], cursor = -1, locked = false;

  const openList  = () => list.classList.add('open');
  const closeList = () => { list.classList.remove('open'); cursor = -1; };

  function confirmLoc(lat, lon) { latEl.value = lat; lonEl.value = lon; locked = true; field.classList.add('field-confirmed'); }
  function clearLoc()            { latEl.value = ''; lonEl.value = ''; locked = false; field.classList.remove('field-confirmed'); }
  function highlight()           { Array.from(list.children).forEach((li,i) => li.classList.toggle('highlighted', i===cursor)); }

  function pick(i) {
    const s = suggestions[i]; if (!s) return;
    input.value = s.short; confirmLoc(s.lat, s.lon); closeList();
  }

  function render(items) {
    list.innerHTML = ''; cursor = -1;
    if (!items.length) { closeList(); return; }
    suggestions = items;
    items.forEach((s, i) => {
      const li = document.createElement('li');
      const full = s.display.length > 72 ? s.display.slice(0,72)+'…' : s.display;
      li.innerHTML = '<div class="ac-short">'+esc(s.short)+'</div><div class="ac-full">'+esc(full)+'</div>';
      li.addEventListener('mousedown', e => { e.preventDefault(); pick(i); });
      list.appendChild(li);
    });
    openList();
  }

  async function search(q) {
    try { const r = await fetch('/api/autocomplete?q='+encodeURIComponent(q)); render(await r.json()); }
    catch(e) {}
  }

  input.addEventListener('keydown', e => {
    if (!list.classList.contains('open')) return;
    if (e.key==='ArrowDown') { e.preventDefault(); cursor=Math.min(cursor+1,suggestions.length-1); highlight(); }
    else if (e.key==='ArrowUp') { e.preventDefault(); cursor=Math.max(cursor-1,0); highlight(); }
    else if (e.key==='Enter' && cursor>=0) { e.preventDefault(); pick(cursor); }
    else if (e.key==='Escape') closeList();
  });
  input.addEventListener('input', () => {
    clearLoc(); const q = input.value.trim(); clearTimeout(timer);
    if (q.length < 2) { closeList(); suggestions=[]; return; }
    timer = setTimeout(() => search(q), 300);
  });
  input.addEventListener('focus', () => { if (suggestions.length && !locked) openList(); });
  document.addEventListener('click', e => { if (!field.contains(e.target)) closeList(); });
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

makeAutocomplete({inputId:'start',listId:'ac-start',latId:'start_lat',lonId:'start_lon',fieldId:'field-start'});
makeAutocomplete({inputId:'end',  listId:'ac-end',  latId:'end_lat',  lonId:'end_lon',  fieldId:'field-end'});

const makeEl  = document.getElementById('makeSelect');
const modelEl = document.getElementById('modelSelect');
const preview = document.getElementById('vehiclePreview');

makeEl.addEventListener('change', async () => {
  modelEl.innerHTML = '<option value="" disabled selected>Loading…</option>';
  preview.classList.remove('show');
  const models = await (await fetch('/api/models?make='+encodeURIComponent(makeEl.value))).json();
  modelEl.innerHTML = '<option value="" disabled selected>Model</option>';
  models.forEach(m => { const o=document.createElement('option'); o.value=m; o.textContent=m; modelEl.appendChild(o); });
});

modelEl.addEventListener('change', async () => {
  const make=makeEl.value, model=modelEl.value; if (!make||!model) return;
  const data = await (await fetch('/api/cars')).json();
  const s = data[make]&&data[make][model]; if (!s) return;
  document.getElementById('vpName').textContent   = make+' '+model;
  document.getElementById('vpDrag').textContent   = s.drag_coefficient;
  document.getElementById('vpEff').textContent    = Math.round(s.efficiency*100)+'%';
  document.getElementById('vpWeight').textContent = s.weight;
  preview.classList.add('show');
});

document.getElementById('routeForm').addEventListener('submit', () => {
  document.getElementById('submitBtn').classList.add('loading');
});

(function animateMapCars() {
  const mapBg = document.querySelector('.left-map-bg');
  if (!mapBg) return;
  const svg = mapBg.querySelector('svg');
  if (!svg) return;

  const viewW = 1200;
  const viewH = 800;

  const cars = Array.from(mapBg.querySelectorAll('.car[data-route]')).map((el) => {
    const routeId = el.getAttribute('data-route');
    const path = routeId ? svg.querySelector('#' + routeId) : null;
    if (!path) return null;
    return {
      el,
      path,
      len: path.getTotalLength(),
      speed: parseFloat(el.getAttribute('data-speed') || '78'),
      phase: parseFloat(el.getAttribute('data-phase') || '0'),
      progress: 0,
      factor: 1
    };
  }).filter(Boolean);
  if (!cars.length) return;

  cars.forEach((car) => {
    car.progress = ((((car.phase % 1) + 1) % 1) * car.len);
  });

  let scaleX = mapBg.clientWidth / viewW;
  let scaleY = mapBg.clientHeight / viewH;

  function syncScale() {
    scaleX = mapBg.clientWidth / viewW;
    scaleY = mapBg.clientHeight / viewH;
  }
  syncScale();
  window.addEventListener('resize', syncScale);

  const cursor = { active: false, x: 0, y: 0 };
  function setCursorFromEvent(e) {
    const r = mapBg.getBoundingClientRect();
    cursor.x = e.clientX - r.left;
    cursor.y = e.clientY - r.top;
    cursor.active = true;
  }
  mapBg.addEventListener('mousemove', setCursorFromEvent);
  mapBg.addEventListener('mouseenter', setCursorFromEvent);
  mapBg.addEventListener('mouseleave', () => { cursor.active = false; });
  mapBg.addEventListener('touchstart', (e) => {
    const t = e.touches && e.touches[0];
    if (!t) return;
    setCursorFromEvent(t);
  }, { passive: true });
  mapBg.addEventListener('touchmove', (e) => {
    const t = e.touches && e.touches[0];
    if (!t) return;
    setCursorFromEvent(t);
  }, { passive: true });
  mapBg.addEventListener('touchend', () => { cursor.active = false; });

  let last = performance.now();
  function tick(now) {
    const dt = Math.max(0, Math.min(0.04, (now - last) / 1000));
    last = now;

    for (const car of cars) {
      const p1 = car.path.getPointAtLength(car.progress);
      const x = p1.x * scaleX;
      const y = p1.y * scaleY;

      let targetFactor = 1;
      if (cursor.active) {
        const dx = cursor.x - x;
        const dy = cursor.y - y;
        const dist = Math.hypot(dx, dy);
        const slowRadius = 56;
        const stopRadius = 14;
        if (dist < slowRadius) {
          const t = Math.max(0, Math.min(1, (dist - stopRadius) / (slowRadius - stopRadius)));
          targetFactor = 0.18 + 0.82 * t;
        }
      }
      const rate = targetFactor < car.factor ? 7.8 : 2.8;
      car.factor += (targetFactor - car.factor) * Math.min(1, rate * dt);
      car.progress = (car.progress + car.speed * car.factor * dt) % car.len;

      const q1 = car.path.getPointAtLength(car.progress);
      const q2 = car.path.getPointAtLength((car.progress + 2) % car.len);
      const qAngle = Math.atan2((q2.y - q1.y) * scaleY, (q2.x - q1.x) * scaleX) * 180 / Math.PI;
      const qx = q1.x * scaleX;
      const qy = q1.y * scaleY;
      car.el.style.transform = 'translate(' + qx + 'px,' + qy + 'px) translate(-50%,-50%) rotate(' + qAngle + 'deg)';
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();

</script>
</body>
</html>
